import{l as v,p as b}from"../chunks/vidstack-BT950sWn.js";import{a as w,n as T}from"../chunks/vidstack-Cv36beFn.js";import{VideoProvider as S}from"./vidstack-video-DmHYVb0n.js";import{H as u,i as c,D as h,j as g,l as f,e as E,Q as L,p as x}from"../chunks/vidstack-B8Kcr51E.js";import{c as A}from"../chunks/vidstack-BfBBPhXV.js";import{Q as p}from"../chunks/vidstack-DRH_1tFW.js";import{a as R,T as y}from"../chunks/vidstack-DzQr9irW.js";import{L as d}from"../chunks/vidstack-C_AxqLKV.js";import{R as q}from"../chunks/vidstack-CXmpN6cA.js";import{g as k}from"../chunks/vidstack-BkOdS8km.js";import"./vidstack-html-D4rH1UMl.js";import"../chunks/vidstack-Bxv1Qnxe.js";import"../chunks/vidstack-Bfhr912K.js";class F{#e;#i;#t;constructor(t,i,e){this.#e=t,this.#i=i,this.#t=e,this.#n()}async#n(){const t={onLoadStart:this.#a.bind(this),onLoaded:this.#s.bind(this),onLoadError:this.#r.bind(this)};let i=await $(this.#e,t);if(u(i)&&!c(this.#e)&&(i=await P(this.#e,t)),!i)return null;if(typeof MediaSource>"u"){const e="[vidstack] Shaka Player is not supported in this environment";return this.#i.player.dispatch(new h("shaka-unsupported")),this.#i.notify("error",{message:e,code:4}),null}return i}#a(){this.#i.player.dispatch(new h("shaka-lib-load-start"))}#s(t){this.#i.player.dispatch(new h("shaka-lib-loaded",{detail:t})),this.#t(t)}#r(t){const i=A(t);this.#i.player.dispatch(new h("shaka-lib-load-error",{detail:i})),this.#i.notify("error",{message:i.message,code:4,error:i})}}async function P(r,t={}){if(!u(r)){if(t.onLoadStart?.(),m(r)){r.polyfill?.installAll?.();const i=r.Player;return t.onLoaded?.(i),i}try{const e=(await r())?.default;if(m(e))return e.polyfill?.installAll?.(),t.onLoaded?.(e.Player),e.Player;throw Error("")}catch(i){t.onLoadError?.(i)}}}async function $(r,t={}){if(c(r)){t.onLoadStart?.();try{await v(r);const i=window.shaka;if(!i||!g(i.Player))throw Error("");i.polyfill?.installAll?.();const e=i.Player;return t.onLoaded?.(e),e}catch(i){t.onLoadError?.(i)}}}function m(r){return r&&"Player"in r&&g(r.Player)}const C=r=>`shaka-${L(r)}`;class Q{#e;#i;#t=null;#n=new Set;#a=null;config={};get instance(){return this.#t}constructor(t,i){this.#e=t,this.#i=i}setup(t){this.#t=new t(this.#e);const i=this.#d.bind(this),e=["buffering","loading","loaded","unloading","adaptation","trackschanged","variantchanged","textchanged","texttrackvisibility","streaming","manifestparsed"];for(const n of e)this.#t.addEventListener(n,i);this.#t.addEventListener("error",this.#k.bind(this));for(const n of this.#n)n(this.#t);this.#i.player.dispatch("shaka-instance",{detail:this.#t}),this.config.config&&this.#t.configure(this.config.config);const s=this.#t.getNetworkingEngine();s&&(this.config.requestFilter&&s.registerRequestFilter(this.config.requestFilter),this.config.responseFilter&&s.registerResponseFilter(this.config.responseFilter)),this.#t.addEventListener("adaptation",this.#y.bind(this)),this.#t.addEventListener("trackschanged",this.#p.bind(this)),this.#t.addEventListener("loaded",this.#u.bind(this)),this.#t.addEventListener("buffering",this.#l.bind(this)),this.#i.qualities[p.enableAuto]=this.#v.bind(this),f(this.#i.qualities,"change",this.#b.bind(this)),f(this.#i.audioTracks,"change",this.#w.bind(this)),this.#a=E(this.#r.bind(this))}#s(t,i){return new h(C(t),{detail:i})}#r(){if(!this.#i.$state.live())return;const t=new q(this.#c.bind(this));return t.start(),t.stop.bind(t)}#c(){if(!this.#t)return;const i=this.#t.seekRange().end-this.#e.currentTime;this.#i.$state.liveSyncPosition.set(isNaN(i)?1/0:i)}#d(t){this.#i.player?.dispatch(this.#s(t.type,t))}#l(t){const i=t,e=this.#s("buffering",t);i.buffering&&this.#i.notify("waiting",void 0,e)}#u(){if(this.#i.$state.canPlay()||!this.#t)return;const t=this.#s("loaded",null),i=this.#t.isLive();if(this.#i.notify("stream-type-change",i?"live":"on-demand",t),i){const e=this.#t.seekRange(),s=e.end-e.start;s>0&&this.#i.notify("duration-change",s,t)}this.#i.qualities[p.setAuto](!0,t),this.#o(t),this.#g(t),this.#f(t),this.#e.dispatchEvent(new h("canplay",{trigger:t}))}#o(t){if(!this.#t)return;const i=this.#t.getVariantTracks(),e=new Map;for(const a of i)if(a.height&&a.width){const o=`${a.height}`;(!e.has(o)||a.bandwidth>e.get(o).bandwidth)&&e.set(o,a)}const s=Array.from(e.values()).sort((a,o)=>(o.height||0)-(a.height||0));for(let a=0;a<s.length;a++){const o=s[a],l={id:`shaka-quality-${o.id}`,width:o.width||0,height:o.height||0,bitrate:o.bandwidth||0,codec:o.videoCodec||o.codecs||"",index:a};this.#i.qualities[d.add](l,t)}const n=i.find(a=>a.active);if(n){const a=this.#i.qualities.toArray().find(o=>o.height===n.height);a&&this.#i.qualities[d.select](a,!0,t)}}#g(t){if(!this.#t)return;this.#t.getAudioLanguagesAndRoles().forEach((e,s)=>{const n={id:`shaka-audio-${s}`,label:e.label||k(e.language)||e.language||"",language:e.language||"",kind:e.role||"main"};this.#i.audioTracks[d.add](n,t)})}#f(t){if(!this.#t)return;this.#t.getTextTracks().forEach((e,s)=>{const n=new R({id:`shaka-text-${e.id}`,label:e.label||k(e.language)||e.language||"",language:e.language||"",kind:e.kind||"subtitles",default:e.primary||!1});n[y.readyState]=2,n[y.onModeChange]=()=>{if(this.#t)if(n.mode==="showing"){const o=this.#t.getTextTracks().find(l=>l.id===e.id);o&&(this.#t.selectTextTrack(o),this.#t.setTextTrackVisibility(!0))}else this.#t.setTextTrackVisibility(!1)},this.#i.textTracks.add(n,t)})}#p(t){const i=this.#s("trackschanged",t);this.#i.qualities.length===0&&this.#o(i)}#y(t){const e=t.newTrack;if(!e||e.type!=="variant")return;const s=this.#i.qualities.toArray().find(n=>n.height===e.height);if(s){const n=this.#s("adaptation",t);this.#i.qualities[d.select](s,!0,n)}}#k(t){const e=t.detail;e&&this.#m(e)}#m(t){this.#i.notify("error",{message:t.message||`Shaka error code: ${t.code}`,code:1,error:t})}#v(){this.#t&&this.#t.configure({abr:{enabled:!0}})}#b(){const{qualities:t}=this.#i;if(!this.#t||t.auto||!t.selected)return;this.#t.configure({abr:{enabled:!1}});const i=this.#t.getVariantTracks(),e=t.selected,s=i.find(n=>n.height===e.height);s&&this.#t.selectVariantTrack(s,t.switch==="current"),w&&(this.#e.currentTime=this.#e.currentTime)}#w(){if(!this.#t)return;const{audioTracks:t}=this.#i;if(t.selected){const e=this.#t.getAudioLanguagesAndRoles(),s=t.selectedIndex;if(s>=0&&s<e.length){const n=e[s];this.#t.selectAudioLanguage(n.language,n.role)}}}registerRequestFilter(t){const i=this.#t?.getNetworkingEngine();i&&i.registerRequestFilter(t)}registerResponseFilter(t){const i=this.#t?.getNetworkingEngine();i&&i.registerResponseFilter(t)}onInstance(t){return this.#n.add(t),()=>this.#n.delete(t)}#h(){}async loadSource(t){if(this.#h(),!(!c(t.src)||!this.#t))try{await this.#t.load(t.src)}catch(i){this.#i.notify("error",{message:i instanceof Error?i.message:"Failed to load source",code:1,error:i})}}async destroy(){this.#h(),this.#t&&(await this.#t.destroy(),this.#t=null),this.#a?.(),this.#a=null}}const D="https://cdn.jsdelivr.net";class I extends S{$$PROVIDER_TYPE="SHAKA";#e=null;#i=new Q(this.video,this.ctx);get ctor(){return this.#e}get instance(){return this.#i.instance}static supported=T();get type(){return"shaka"}get canLiveSync(){return!0}#t=`${D}/npm/shaka-player@4.15.1/dist/shaka-player.compiled.js`;get config(){return this.#i.config}set config(t){this.#i.config=t}get library(){return this.#t}set library(t){this.#t=t}preconnect(){c(this.#t)&&b(this.#t)}setup(){super.setup(),new F(this.#t,this.ctx,t=>{this.#e=t,this.#i.setup(t),this.ctx.notify("provider-setup",this);const i=x(this.ctx.$state.source);i&&this.loadSource(i)})}async loadSource(t,i){if(!c(t.src)){this.removeSource();return}this.media.preload=i||"",this.appendSource(t,t.type||"application/dash+xml"),await this.#i.loadSource(t),this.currentSrc=t}onInstance(t){const i=this.#i.instance;return i&&t(i),this.#i.onInstance(t)}registerRequestFilter(t){this.#i.registerRequestFilter(t)}registerResponseFilter(t){this.#i.registerResponseFilter(t)}destroy(){this.#i.destroy()}}export{I as ShakaProvider};
